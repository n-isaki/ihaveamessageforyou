rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper Functions
    function isAdmin() {
      return request.auth != null;
    }
    
    function isValidToken() {
      // Token validation via query parameter (for single document reads)
      return request.query.limit == 1 && 
             request.query.token != null &&
             resource.data.securityToken == request.query.token;
    }
    
    function isUnlocked() {
      // Allow reading unlocked gifts (for setup links)
      // Security: Unlocked gifts don't contain sensitive data yet (messages are added during setup)
      // Token validation happens client-side in CustomerSetup.jsx
      return !isLocked();
    }
    
    function isOwner() {
      // Check if user has valid token for this document
      // Token must match AND not be changed during update
      return request.resource.data.securityToken == resource.data.securityToken
             && request.resource.data.securityToken != null;
    }
    
    function hasValidTokenInUpdate() {
      // Check if the update includes a matching securityToken (sent from client)
      // This allows updates when token is validated client-side and included in update data
      // Token must exist in both old and new data and match
      return request.resource.data.securityToken != null
             && resource.data.securityToken != null
             && request.resource.data.securityToken == resource.data.securityToken;
    }
    
    function isLocked() {
      return resource.data.get('locked', false) == true;
    }
    
    function onlyAllowedFields(fields) {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(fields);
    }
    
    match /gift_orders/{documentId} {
      
      // READ: 
      // 1. Admin can always read
      // 2. With valid token (for setup links) - query.limit=1
      // 3. Unlocked gifts are readable (PUBLIC METADATA ONLY via Cloud Function for locked gifts!)
      // ⚠️ SECURITY FIXED: Locked gifts are NO LONGER publicly readable via Firestore.
      // Use getPublicGiftData cloud function for lock screen metadata.
      allow read: if isAdmin() 
                  || isValidToken()
                  || (resource.data.locked == false) // ✅ ONLY unlocked gifts are public
                  || (resource.data.isPublic == true); // ✅ Allow reading if public (Open Access)
      
      // CREATE: Only Admin or Shopify Webhook (with shopifyOrderId)
      allow create: if isAdmin() 
                   || (request.resource.data.platform == 'shopify' 
                       && request.resource.data.shopifyOrderId != null)
                   || (request.resource.data.platform == 'etsy'
                       && request.resource.data.etsyOrderId != null);
      
      // UPDATE: 
      // 1. Admin can always update
      // 2. Setup Phase (NOT locked): Allow updates if token matches OR if only updating setupStarted/setupStartedAt
      // 3. Locked: Only 'viewed'/'viewedAt' can be updated
      // 4. Anyone can update 'viewed'/'viewedAt' (for viewer pages to mark as seen)
      allow update: if isAdmin()
                  || (!isLocked() 
                      && hasValidTokenInUpdate()
                      && onlyAllowedFields(['messages', 'headline', 'subheadline', 'albumImages', 'locked', 
                                            'setupCompletedAt', 'setupStarted', 'setupStartedAt',
                                            'deceasedName', 'lifeDates', 'meaningText',
                                            'engravingText', 'meaningText', 'accessCode', 'accessCodeHash', 'securityToken', 'updatedAt', 'allowContributions', 'isPublic']))
                  || (!isLocked() 
                      && onlyAllowedFields(['setupStarted', 'setupStartedAt', 'updatedAt'])) // ✅ removed isPublic (Security Risk)
                  || onlyAllowedFields(['viewed', 'viewedAt', 'updatedAt']); // ✅ Erlaube viewed/viewedAt Updates für alle (locked oder unlocked)
      
      // DELETE: Only Admin
      allow delete: if isAdmin();

      // ============================================
      // SUBSCRIPTION: Social Gifting Contributions
      // ============================================
      match /contributions/{contributionId} {
         // READ: 
         // 1. Admin (always)
         // 2. Owner of parent gift via securityToken (Viewer/Setup)
         // Note: Contributors CANNOT read other messages (Write-Only Privacy)
          allow read: if isAdmin() 
                      || (get(/databases/$(database)/documents/gift_orders/$(documentId)).data.securityToken == request.query.token)
                      || (get(/databases/$(database)/documents/gift_orders/$(documentId)).data.locked == false)
                      || (get(/databases/$(database)/documents/gift_orders/$(documentId)).data.isPublic == true);

         // CREATE: Public write access IF they have the valid contributionToken
         // Token validation: Payload token === Parent Gift token
         allow create: if request.resource.data.contributionToken == get(/databases/$(database)/documents/gift_orders/$(documentId)).data.contributionToken;

         // UPDATE/DELETE: Only Admin (Contributors cannot edit/delete once sent)
         allow update, delete: if isAdmin();
      }
    }
    
    // ============================================
    // KARAKEDIMARTIN - Separate Collections mit Prefix
    // ============================================
    
    match /karakedimartin_notes/{noteId} {
      // READ: Public notes are readable by everyone, private only by owner
      allow read: if resource.data.isPublic == true 
                  || isAdmin();
      
      // CREATE: Only authenticated users (you)
      allow create: if isAdmin();
      
      // UPDATE: Only owner (you)
      allow update: if isAdmin();
      
      // DELETE: Only owner (you)
      allow delete: if isAdmin();
    }
    
    match /karakedimartin_links/{linkId} {
      // READ: Public links are readable by everyone, private only by owner
      allow read: if resource.data.isPublic == true 
                  || isAdmin();
      
      // CREATE: Only authenticated users (you)
      allow create: if isAdmin();
      
      // UPDATE: Only owner (you)
      allow update: if isAdmin();
      
      // DELETE: Only owner (you)
      allow delete: if isAdmin();
    }
    
    match /karakedimartin_collections/{collectionId} {
      // READ: Public collections are readable by everyone, private only by owner
      allow read: if resource.data.isPublic == true 
                  || isAdmin();
      
      // CREATE: Only authenticated users (you)
      allow create: if isAdmin();
      
      // UPDATE: Only owner (you)
      allow update: if isAdmin();
      
      // DELETE: Only owner (you)
      allow delete: if isAdmin();
    }
  }
}
